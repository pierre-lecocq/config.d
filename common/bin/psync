#!/bin/bash
# -*- mode: sh-mode; -*-

# File: psync.sh
# Time-stamp: <2016-04-05 14:55:11>
# Copyright (C) 2016 Pierre Lecocq
# Description: Sync a directory

usage() {
    echo "Usage: $(basename $0) [-s|--src /path/to/src] [-d|--dest /path/to/dest] [-f|--force]";
    exit 1;
}

# Check rsync

rsync_bin=$(which rsync)

if [ -z "$rsync_bin" ]; then
    echo "rsync not found"
    exit 1
fi

if [ -z $RSYNC_OPTS ]; then
    rsync_opts="--archive --delete"
fi

# Get options

force=0
dest=""
src=""
while getopts ":d::s::f" opt; do
    case $opt in
        f) force=1;;
        s) src=$OPTARG;;
        d) dest=$OPTARG;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done

if [ -z "$src" ] && [ -z "$dest" ]; then
    usage
fi

if [ -z "$src" ]; then
    src=$(pwd)
fi

if [ -z "$dest" ]; then
    dest=$(pwd)
fi

src=${src%/}
dest=${dest%/}

# Build command

cmd="$rsync_bin $rsync_opts $src $dest"

if [ "$force" == "0" ]; then
    read -p "Execute $cmd? (y/n) : " answer
    case "$answer" in
        "y" | "Y") ;;
        *)
            echo "Abort."
            exit 1
            ;;
    esac
fi

`$cmd`

echo "Done"
